/*Copyright (c) Kaerus 2012 (kaerus.com), Anders Elo <anders @ kaerus com>*/
var root;try{root=global}catch(e){try{root=window}catch(e){root=this}}(function(e){"use strict";function u(){if(!(this instanceof u))return new u}if(typeof exports=="object")typeof module!==undefined&&module.exports?exports=module.exports=u:exports.Promise=u;else if(typeof define=="function"&&define.amd)define("promise",[],function(){return u});else{if(typeof e!="object")throw"Unable to export Promise";e.Promise=u}var t=e.setImmediate;if(typeof t!="function")if(typeof e.process!="undefined"&&e.process&&typeof e.process.nextTick=="function")t=e.process.nextTick;else if(e.vertx&&typeof e.vertx.runOnLoop=="function")t=e.vertx.runOnLoop;else if(typeof e.MessageChannel!="undefined"){var n=[],r=new e.MessageChannel;r.port1.onmessage=function(){n.shift()()},t=function(e){n[n.length]=e,r.port2.postMessage()}}else{if(typeof e.setTimeout!="function")throw"No candidate for setImmediate";t=e.setTimeout}var i=0,s=1,o=2;u.prototype.resolve=function(){var e,t,n=this.state,r=this.resolved;while(e=this.calls.shift()){t=e[i];if(typeof e[this.state]=="function"){try{r=e[this.state](this.resolved)}catch(o){t.reject(o);continue}if(r instanceof u||r&&typeof r.then=="function"){r.then(function(e){t.fulfill(e)},function(e){t.reject(e)});continue}n=s}t.state=n,t.resolved=r,t.calls&&t.resolve()}},u.prototype.then=function(e,n){var r=this,i=new u;return this.calls||(this.calls=[]),this.calls[this.calls.length]=[i,e,n],this.resolved&&t(function(){r.resolve()}),i},u.prototype.spread=function(e,t){function n(t){return Array.isArray(t)||(t=[t]),e.apply(null,t)}return this.then(n,t)},u.prototype.fulfill=function(e){if(this.state)return;return arguments.length>1&&(e=[].slice.call(arguments)),this.state=s,this.resolved=e,this.calls&&this.resolve(),this},u.prototype.reject=function(e){if(this.state)return;return this.state=o,this.resolved=e,this.calls&&this.resolve(),this},u.prototype.when=function(e){function s(e,n){var r;return n instanceof u||n&&typeof n.then=="function"?n.then(function(t){e.fulfill(t)},function(t){e.reject(t)}):t(function(){try{r=n.call(e),e.fulfill(r)}catch(t){e.reject(t)}}),e}function o(t,n){return s(t,e[n]).then(function(e){i[n]=e}),function(){return t}}var n,r=n=this,i=[];if(!Array.isArray(e))return s(this,e);for(var a=0;a<e.length;a++)n=r,r=n.then(o(n,a));return n.then(function(){return i})},u.prototype.attach=function(e){return this.attached=e,this},u.prototype.abort=function(e){return this.attached&&typeof this.attached.abort=="function"&&this.attached.abort(),this.reject(e),this},u.prototype.timeout=function(e,t){var n=this;return t||(t=function(){n.abort("timed out")}),e!==null?this.timer=setTimeout(t,e):this.timer&&(clearTimeout(this.timer),this.timer=undefined),this}})(root);