/*Copyright (c) Kaerus 2012 (kaerus.com), Anders Elo <anders @ kaerus com>*/
function Promise(){if(!(this instanceof Promise))return new Promise}(function(e){typeof exports=="object"?module.exports=Promise:typeof define=="function"&&define.amd?define("promise",[],function(){return Promise}):e.Promise=Promise})(this);if(typeof setImmediate!="function")if(typeof process!="undefined"&&process&&typeof process.nextTick=="function")setImmediate=process.nextTick;else if(typeof MessageChannel!="undefined"){var fifo=[],channel=new MessageChannel;channel.port1.onmessage=function(){fifo.shift()()},setImmediate=function(e){fifo[fifo.length]=e,channel.port2.postMessage()}}else setImmediate=setTimeout;var PENDING=0,FULFILLED=1,REJECTED=2;Promise.prototype.resolve=function(){var e,t,n=this.state,r=this.resolved;while(e=this.calls.shift()){t=e[PENDING];if(typeof e[this.state]=="function"){try{r=e[this.state](this.resolved)}catch(i){t.reject(i);continue}if(r instanceof Promise||r&&typeof r.then=="function"){r.then(function(e){t.fulfill(e)},function(e){t.reject(e)});continue}n=FULFILLED}t.state=n,t.resolved=r,t.calls&&t.resolve()}},Promise.prototype.then=function(e,t){var n=this,r=new Promise;return this.calls||(this.calls=[]),this.calls[this.calls.length]=[r,e,t],this.resolved&&setImmediate(function(){n.resolve()}),r},Promise.prototype.spread=function(e,t){function n(t){return!Object.prototype.toString.call(t)==="[object Array]"&&(t=[t]),e.apply(null,t)}return this.then(n,t)},Promise.prototype.fulfill=function(e){if(this.state)return;return arguments.length>1&&(e=Array.prototype.slice.call(arguments)),this.state=FULFILLED,this.resolved=e,this.calls&&this.resolve(),this},Promise.prototype.reject=function(e){if(this.state)return;return this.state=REJECTED,this.resolved=e,this.calls&&this.resolve(),this};